version: "3.9"
services:
  mongo:
    image: mongo:7
    container_name: mongo
    ports: ["27018:27017"]
    env_file: .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
      MONGO_DB: ${MONGO_DB}
      MONGO_APP_USER: ${MONGO_APP_USER}
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD}
    volumes:
      - mongo_data:/data/db
      - ./docker/mongo-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
  # One-time ownership fix for the reports volume (runs as root; exits)
  reports-init:
    image: busybox:1.36
    volumes:
      - reports_data:/reports
    command: ["sh", "-lc", "mkdir -p /reports && chown -R 10001:10001 /reports"]
  loader:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: loader
    depends_on:
      mongo:
        condition: service_healthy
    env_file: .env
    environment:
      CSV_PATH: /data/${CSV_FILENAME}
      MONGO_URI: mongodb://${MONGO_APP_USER}:${MONGO_APP_PASSWORD}@mongo:27017/${MONGO_DB}?authSource=${MONGO_DB}
      MONGO_DB: ${MONGO_DB}
      MONGO_COLLECTION: ${MONGO_COLLECTION}
      LOG_LEVEL: ${LOG_LEVEL}
      REPORT_PATH: /reports/report.txt
    volumes:
      - ./data:/data:ro           # CSV input from host (read-only)
      - reports_data:/reports     # named volume for report output (writable)
    command: ["python", "migrate_to_mongo.py", "--create-indexes", "--upsert"]
volumes:
  mongo_data:
    driver: local
  reports_data:
    driver: local